1. ## <a name="_toc268791588"></a><a name="_toc269981753"></a><a name="_toc496253744"></a>**指令对账机制和异常状态处理机制**

本章节对企业财务软件连接兴业银行银企直联系统实现非常重要，请企业财务软件技术人员认真阅读，按照兴业银行建议的模式建立指令对账机制和异常状态处理机制。

企业的软件开发方开发接口，资金管理软件或财务软件必须建立与本行系统的指令对账机制和异常状态处理机制。建议对账机制基于本行接口的客户端交易流水号TRNUID节点进行设计。

在银企直联报文传送的过程中，受网络环境的影响，在报文流转的各个环节：企业财务软件至银企直联代理服务软件－>银企直联代理服务软件到银行银企直联服务器－>银行处理指令后向银企直联代理服务软件返回处理结果－>企业财务软件读取处理结果，这几个环节都有可能出现网络方面的不稳定造成超时等异常情况。出现超时后，并不代表该指令已经失败或者已经成功，是一种没有获得银行应答而无法判断银行是否已经处理的状态。这种情况下，银行有可能已经处理，或者没有处理；若企业端财务软件返回给业务人员是指令失败的提示，而业务人员贸然重新发起指令，很可能造成重复出账。因此，强烈建议出现这种情况时，企业财务软件把该指令的状态置为一种“结果未知”的处理状态，并规范业务人员在未经确认的情况下不要贸然重发指令，而是采取指令对账机制和异常处理机制来进行处理。

指令对账机制就是企业财务软件在未获取指令的银行处理结果时，向银行同步处理结果的方法，该方法同样适用于出现超时等异常状态时的处理。具体机制如下：银企直联每一笔交易对应一个客户端交易流水号TRNUID。发起交易时需要控制报文中TRNUID的唯一性。

当不能确定第一次转账是否成功时，不要启用一个新的交易流水号重发交易，以免生成一笔新的交易指令造成重复出账。

当资金管理软件或财务软件发出的交易指令没有获得银行应答或者出现超时造成交易结果未知时，建议按照以下两种机制进行操作：

1、发起转账交易后，可以实时等待银行返回报文以获取银行处理结果，也可以设定另外一个定时交易调用“查询转账交易状态”接口（时间间隔15分钟以上），与银行系统核对交易状态，进行对账。

2、若个别指令在调用“查询转账交易状态”后，仍然无法获取银行最终处理结果，可以致电企业账号的开户行柜面查询流水，查询该笔指令的银行最终处理结果后，确定该笔指令的状态和后续处理方式。